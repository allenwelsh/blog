### 微前端

#### 一、意义

微前端架构具备以下几个核心价值：

- 技术栈无关
  主框架不限制接入应用的技术栈，微应用具备完全自主权

- 独立开发、独立部署
  微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新

- 增量升级

在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略

- 独立运行时
  每个微应用之间状态隔离，运行时状态不共享

#### 二、常用解决方案

- nginx 路由转发
- iframe 嵌套
- 微前端框架

#### 三、微前端实现技术

微服务实现的角色是：

- 导航路由 + 资源加载+启动、卸载+通信+框架

主要问题：

- 路由导航
  由于我们的子应用都是 lazy load 的，当浏览器重新刷新时，主框架的资源会被重新加载，同时异步 load 子应用的静态资源，由于此时主应用的路由系统已经激活，但子应用的资源可能还没有完全加载完毕，从而导致路由注册表里发现没有能匹配子应用 /subApp/123/detail 的规则，这时候就会导致跳 NotFound 页或者直接路由报错。

解决思路：

路由问题：

- 1、主应用先加载主应用逻辑代码，加载完成后，根据路由配置文件判断接下来需要加载的子应用；
- 2、加载子应用的时候先加载子的 html 文件，然后通过解析将微应用的 JavaScript 和 CSS 进行抽离，通过 eval 方法运行 js 代码，同时将 css 和 html 插入到主应用留给微应用的展示区域，在卸载时候删除这部分 css 代码
- 2、主应用通过修改 history 的 hash 或者 pushState，同时子应用手动监听 hashchange 或者 popstate 事件接收路由；

js 变量污染 和 css 样式冲突

- css 可以通过命名空间解决，postcss-namespace
- js 主要是解决全局变量污染问题，可以采用沙箱机制（Proxy、iframe）

（基于 Proxy+window 更新的沙箱实现）

- 原理是同一时刻只有一个微应用，所以需要实现一个代理操作全局变量，当卸载的是将之前的全局变量回复即可

- 父子通信（消息通信）

- redux 或者 Vuex

#### 参考文章

[微前端解决方案](https://segmentfault.com/a/1190000040275586)
[微前端的核心价值](https://zhuanlan.zhihu.com/p/95085796)
[可能是你见过最完善的微前端解决方案](可能是你见过最完善的微前端解决方案)
[微前端在美团外卖的实践](https://tech.meituan.com/2020/02/27/meituan-waimai-micro-frontends-practice.html)
[微前端在小米 CRM 系统的实践](https://xiaomi-info.github.io/2020/04/14/fe-microfrontends-practice/)
[最容易看懂的微前端知识](https://juejin.cn/post/6844904162509979662)
[基于 Proxy+window 更新的沙箱实现](https://cloud.tencent.com/developer/article/1748172)
[30 分钟快速掌握微前端 qiankun 的所有核心技术](https://ths.js.org/2021/01/31/30%E5%88%86%E9%92%9F%E5%BF%AB%E9%80%9F%E6%8E%8C%E6%8F%A1%E5%BE%AE%E5%89%8D%E7%AB%AFqiankun%E7%9A%84%E6%89%80%E6%9C%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/)
